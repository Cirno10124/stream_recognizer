# 自适应音频提取功能

## 概述

本系统现在支持自适应音频提取，能够智能检测视频文件的音频流参数，并使用最优的FFmpeg配置将音频转换为语音识别所需的16kHz单声道PCM格式。

## 功能特点

### 1. 自动音频流检测
- 使用 `ffprobe` 自动检测原始音频格式
- 支持检测：编解码器、采样率、声道数
- 智能处理各种输入格式

### 2. 自适应重采样策略

#### 高采样率降采样（>16kHz）
```bash
# 使用高质量SoX重采样器
aresample=resampler=soxr:precision=28:cutoff=0.95:dither_method=triangular
```
- 28位精度处理
- 0.95抗混叠截止频率
- 三角抖动降噪

#### 低采样率上采样（<16kHz）
```bash
# 使用线性插值
aresample=resampler=linear
```

### 3. 智能声道处理

#### 立体声到单声道
```bash
# 平衡混音，保持音量
pan=mono|c0=0.5*c0+0.5*c1
```

#### 多声道到单声道
```bash
# 智能混音，优先中央和前置声道
pan=mono|c0=FC+0.5*FL+0.5*FR
```

### 4. 音频增强处理

#### 高通滤波
```bash
# 去除85Hz以下的低频噪声
highpass=f=85
```

#### 动态范围压缩
```bash
# 提高语音清晰度，减少音量差异
compand=attacks=0.3:decays=0.8:points=-80/-80|-45/-15|-27/-9:soft-knee=6:gain=0:volume=0.95
```

#### 音量标准化
```bash
# 防止削波，保持适中音量
volume=0.9
```

## 技术实现

### 核心函数

#### `detectAudioStreamInfo()`
- 检测媒体文件的音频流信息
- 解析JSON格式的ffprobe输出
- 返回结构化的音频参数

#### `buildAdaptiveFFmpegCommand()`
- 根据检测到的音频参数构建优化的FFmpeg命令
- 智能选择最佳的过滤器链
- 确保输出质量和兼容性

### 使用示例

```cpp
// 自动检测并提取音频
AudioProcessor processor;
bool success = processor.extractAudioFromVideo("input.mp4", "output.wav");

if (success) {
    std::cout << "音频提取成功，格式：16kHz单声道PCM" << std::endl;
}
```

## 支持的输入格式

### 视频格式
- MP4, AVI, MKV, MOV, WMV, FLV 等

### 音频编码
- AAC, MP3, AC3, PCM, FLAC, OGG 等

### 采样率
- 自动处理 8kHz - 192kHz 范围的采样率
- 智能优化到16kHz

### 声道配置
- 单声道、立体声、5.1环绕声等
- 智能混音到单声道

## 性能优化

### 动态超时
- 根据文件大小自动调整处理超时
- 每MB文件给予5秒处理时间
- 最大超时限制5分钟

### 质量验证
- 自动验证输出文件格式
- 确认采样率和声道数正确性
- 提供详细的处理日志

## 错误处理

### 容错机制
- ffprobe超时自动降级到默认参数
- 网络/IO错误的优雅处理
- 详细的错误日志记录

### 调试支持
- 可选的详细命令日志输出
- 性能统计和质量指标
- 用户友好的状态提示

## 优势

1. **质量保证**：智能参数选择确保最佳音频质量
2. **兼容性**：支持广泛的输入格式
3. **性能**：优化的处理流程，最小化转换时间
4. **用户体验**：自动化处理，无需手动设置参数
5. **可靠性**：强健的错误处理和恢复机制 