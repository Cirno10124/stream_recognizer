# 逐行矫正功能使用指南

## 功能概述

逐行矫正功能是对DeepSeek矫正服务的增强版本，它能够：

1. **实时逐行处理**：从第二行输出开始，每准备输出一行时，将其与上一行一并交给矫正服务
2. **上下文连贯性**：基于前面1-3行的历史记录来矫正当前行，确保语义连贯
3. **去重和合并**：自动处理重复内容，优化输出质量
4. **智能切换**：可以在传统全文矫正和逐行矫正之间切换

## 设计优势

### 相比传统矫正的优势：
- **更好的实时性**：用户能看到逐步矫正的过程
- **更强的上下文理解**：每行都能利用前面几行的上下文信息
- **减少重复错误**：前一行的矫正结果能帮助矫正当前行
- **更高的准确性**：逐行处理比一次性处理大段文本更精准

## 技术实现

### 核心组件

1. **OutputCorrector类增强**
   - 新增 `correctLineByLine()` 方法
   - 维护历史记录队列（最多保存3行）
   - 特殊的逐行矫正提示词设计

2. **AudioProcessor类集成**
   - 新增逐行矫正开关：`line_by_line_correction_enabled`
   - 行计数器管理：`line_count`
   - 线程安全的互斥锁：`line_correction_mutex`

3. **配置管理**
   - 配置文件支持：`output_correction.line_by_line_enabled`
   - 运行时动态切换支持

### 工作流程

```
第1行输出 -> 跳过矫正（建立历史记录）
第2行输出 -> 使用第1行作为上下文进行矫正
第3行输出 -> 使用第1-2行作为上下文进行矫正
第N行输出 -> 使用最近3行作为上下文进行矫正
```

## 配置方法

### 1. 配置文件设置 (config.json)

```json
{
  "output_correction": {
    "enabled": true,
    "line_by_line_enabled": true,
    "deepseek_server_url": "http://localhost:8000",
    "deepseek_model": "deepseek-coder-7b-instruct-v1.5"
  }
}
```

### 2. 代码API调用

```cpp
// 启用基础矫正功能
audioProcessor->setOutputCorrectionEnabled(true);

// 启用逐行矫正（会自动启用基础矫正）
audioProcessor->setLineByLineCorrectionEnabled(true);

// 配置DeepSeek服务
OutputCorrector::CorrectionConfig config;
config.server_url = "http://localhost:8000";
config.model_name = "deepseek-coder-7b-instruct-v1.5";
audioProcessor->setOutputCorrectionConfig(config);

// 重置历史记录（新会话开始时）
audioProcessor->resetOutputLineHistory();
```

## 提示词设计

逐行矫正使用专门优化的提示词：

```
你是一个专业的语音识别输出矫正助手。请对当前行的语音识别结果进行矫正，需要考虑上下文的连贯性。

任务要求：
1. 纠正当前行中明显的语音识别错误（如同音字错误）
2. 根据上下文调整当前行的内容，确保语义连贯
3. 补充缺失的标点符号
4. 优化语句的通顺性和可读性
5. 保持原意不变，不要添加原文没有的信息
6. 如果是英文，请纠正语法和拼写错误
7. 只输出矫正后的当前行内容，不要输出上下文
8. 如果当前行与上一行内容重复，请去重或合并处理

上下文：
[前面几行的内容]

当前行：[当前需要矫正的行]

请输出矫正后的当前行：
```

## 使用场景

### 适合逐行矫正的场景：
- 实时语音识别
- 长文档处理
- 对话记录
- 会议纪要
- 需要保持语义连贯性的场景

### 适合传统矫正的场景：
- 短文本处理
- 独立语句矫正
- 批量文本处理

## 性能考虑

1. **网络请求频率**：逐行矫正会增加网络请求次数
2. **延迟控制**：每行矫正的超时时间为30秒
3. **错误处理**：服务不可用时自动回退到原始文本
4. **内存管理**：历史记录限制为3行，防止内存泄漏

## 日志监控

系统会输出详细的矫正日志：

```
[INFO] 逐行矫正功能已启用
[INFO] 第一行输出，跳过矫正: 你好世界...
[INFO] 正在进行第2行的逐行矫正...
[INFO] 第2行矫正完成
[INFO] 原文本: 这是一个测试...
[INFO] 矫正后: 这是一个测试句子...
```

## 故障排除

### 常见问题：

1. **服务不可用**
   - 检查 DeepSeek API 服务是否运行
   - 验证服务器地址和端口
   - 查看网络连接状态

2. **矫正效果不佳**
   - 调整模型参数（temperature, max_tokens）
   - 优化提示词内容
   - 检查上下文历史记录

3. **性能问题**
   - 监控网络延迟
   - 调整超时时间
   - 考虑使用批量处理

## 扩展建议

1. **自适应历史长度**：根据文本类型动态调整历史记录行数
2. **智能跳过**：对于明显正确的行跳过矫正以提高效率
3. **批量优化**：支持多行批量矫正以减少网络请求
4. **缓存机制**：对相似文本使用缓存结果

---

*该功能已完全集成到现有的stream_recognizer项目中，可以与现有的识别模式无缝配合使用。* 